stages:
    - build
    - deploy

variables:
    # When using dind service, you must instruct docker to talk with the
    # daemon started inside of the service. The daemon is available with
    # a network connection instead of the default /var/run/docker.sock socket.
    #
    # The 'docker' hostname is the alias of the service container as described at
    # https://docs.gitlab.com/ee/ci/docker/using_docker_images.html#accessing-the-services
    #
    # DOCKER_HOST: tcp://docker:2375
    #
    # This instructs Docker not to start over TLS.
    # DOCKER_TLS_CERTDIR: ""
    # variables:
    # GIT_SUBMODULE_STRATEGY: recursive
    DOCKER_TLS_CERTDIR: "/certs"

build:
    # Use the official docker image.
    image: docker:cli
    stage: build
    services:
        - docker:dind
    variables:
        GIT_SUBMODULE_STRATEGY: recursive
        DOCKER_IMAGE_NAME: $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG
    before_script:
        - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" $CI_REGISTRY
    # All branches are tagged with $DOCKER_IMAGE_NAME (defaults to commit ref slug)
    # Default branch is also tagged with `latest`
    script:
        - docker build --pull -t "$DOCKER_IMAGE_NAME" .
        - docker push "$DOCKER_IMAGE_NAME"
        - |
            if [[ "$CI_COMMIT_BRANCH" == "$CI_DEFAULT_BRANCH" ]]; then
              docker tag "$DOCKER_IMAGE_NAME" "$CI_REGISTRY_IMAGE:latest"
              docker push "$CI_REGISTRY_IMAGE:latest"
            fi
    tags:
        - docker
    # Run this job in a branch where a Dockerfile exists
    only:
        - main
        - dev

deploy-prod:
    stage: deploy
    image: docker:cli
    services:
        - docker:dind
    variables:
        DOCKER_IMAGE_NAME: $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG
    before_script:
        - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" $CI_REGISTRY
    script:
        - docker stop demo || true && docker rm demo || true
        - docker system prune -a -f
        - docker pull "$DOCKER_IMAGE_NAME"
        - docker run --name demo -d --restart unless-stopped -p 80:8000 "$DOCKER_IMAGE_NAME"
    tags:
        - deploy
    only:
        - main

deploy-dev:
    stage: deploy
    image: docker:cli
    services:
        - docker:dind
    variables:
        DOCKER_IMAGE_NAME: $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG
    before_script:
        - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" $CI_REGISTRY
    script:
        - docker stop demo-dev || true && docker rm demo-dev || true
        - docker system prune -a -f
        - docker pull "$DOCKER_IMAGE_NAME"
        - docker run --name demo-dev -d --restart unless-stopped -p 8000:8000 "$DOCKER_IMAGE_NAME"
    tags:
        - deploy
    only:
        - dev

# .base_ruff:
#   stage: build
#   interruptible: true
#   image:
#     name: ghcr.io/astral-sh/ruff:0.14.11-alpine
#   before_script:
#     - cd $CI_PROJECT_DIR
#     - ruff --version

# Ruff Check:
#   extends: .base_ruff
#   script:
#     - ruff check backend/ --output-format=gitlab --output-file=code-quality-report.json
#   artifacts:
#     reports:
#       codequality: $CI_PROJECT_DIR/code-quality-report.json

# Ruff Format:
#   extends: .base_ruff
#   script:
#     - ruff format backend/ --diff
